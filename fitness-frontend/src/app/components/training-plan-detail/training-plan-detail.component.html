<div class="container mt-4" *ngIf="plan">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-secondary" (click)="goBack()">Zurück</button>
    <span class="badge bg-info text-dark">ID: {{ plan.id }}</span>
  </div>

  <h3>Plan bearbeiten: {{ plan.name }}</h3>

  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

  <form [formGroup]="editForm" (ngSubmit)="saveChanges()" class="card p-3 mb-5 shadow-sm">
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Name des Plans</label>
        <input
          type="text"
          class="form-control"
          formControlName="name"
          [class.is-invalid]="editForm.get('name')?.invalid && (editForm.get('name')?.dirty || editForm.get('name')?.touched)"
        />
        <div class="invalid-feedback">
          Der Name des Plans darf nicht leer sein.
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <label class="form-label">Beschreibung</label>
        <input
          type="text"
          class="form-control"
          formControlName="description"
        />
      </div>
    </div>
    <button type="submit" class="btn btn-success" [disabled]="editForm.invalid">Plan-Änderungen speichern</button>
  </form>

  <hr />

  <div class="row">
    <div class="col-md-4">
      <div class="card bg-light mb-3">
        <div class="card-header fw-bold">Neue Session hinzufügen</div>
        <div class="card-body">
          <form [formGroup]="sessionForm" (ngSubmit)="addSession()">
            <div class="mb-3">
              <label class="form-label">Session Name</label>
              <input
                type="text"
                class="form-control"
                formControlName="name"
                placeholder="z.B. Brusttraining A"
                [class.is-invalid]="sessionForm.get('name')?.invalid && (sessionForm.get('name')?.dirty || sessionForm.get('name')?.touched)"
              />
              <div class="invalid-feedback">
                Bitte einen Namen eingeben.
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Geplantes Datum</label>
              <input
                type="date"
                class="form-control"
                formControlName="scheduledDate"
                [class.is-invalid]="sessionForm.get('scheduledDate')?.invalid && (sessionForm.get('scheduledDate')?.dirty || sessionForm.get('scheduledDate')?.touched)"
              />
              <div class="invalid-feedback">
                Datum ist erforderlich.
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Übungen hinzufügen</label>
              <select multiple class="form-select exercise-select" formControlName="exerciseIds">
                <option *ngFor="let ex of availableExercises" [value]="ex.id">
                  {{ ex.name }} ({{ ex.category }})
                </option>
              </select>
              <small class="text-muted d-block mt-1">
                Halte <kbd>STRG</kbd> (Win) oder <kbd>CMD</kbd> (Mac) gedrückt, um mehrere zu wählen.
              </small>
            </div>

            <button type="submit" class="btn btn-primary w-100" [disabled]="sessionForm.invalid">
              Session hinzufügen
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <h4>Geplante Sessions</h4>
      <div *ngIf="!plan.hasSessions" class="alert alert-warning">
        {{ plan.sessionsHint }}
      </div>

      <div class="table-responsive" *ngIf="plan.hasSessions">
        <table class="table table-bordered table-hover bg-white align-middle">
          <thead class="table-dark">
          <tr>
            <th>Datum</th>
            <th>Name</th>
            <th>Übungen</th>
            <th>Status</th>
            <th>Aktion</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let session of plan.sessions">
            <td>{{ session.scheduledDate }}</td>
            <td>{{ session.name }}</td>
            <td>
              <span class="badge bg-secondary">{{ session.exerciseCount }} Übungen</span>
            </td>
            <td>
              <button
                class="btn btn-sm w-100"
                [class.btn-outline-success]="session.status === 'ABGESCHLOSSEN'"
                [class.btn-outline-primary]="session.status === 'GEPLANT'"
                (click)="toggleStatus(session)"
              >
                <i class="bi" [class.bi-check-circle-fill]="session.status === 'ABGESCHLOSSEN'" [class.bi-clock]="session.status === 'GEPLANT'"></i>
                {{ session.status }}
              </button>
            </td>
            <td class="d-flex gap-2">
              <a class="btn btn-sm btn-outline-info"
                 [routerLink]="['/plans', plan.id, 'sessions', session.id]">
                Vorlage / Übungen
              </a>
              <button class="btn btn-danger btn-sm" (click)="deleteSession(session)">
                Entfernen
              </button>
            </td>
          </tr>
          </tbody>
          </table>
      </div>
    </div>
  </div>
</div>
